# fm-doc-canvas

フリーキャンバスAIメモツール

## システム構成

- Wails によるローカル動作アプリケーション
- フロントエンドは React + Zustand + Tailwind
- プロジェクトマネージ＆ツールは mise
- リポジトリ管理は jj

## こんなアプリです

### テキストメモ機能基本

- free canvas にノード形式でテキストを置いて、繋げられる形の情報掲載ツール
- テキストボックスのテキストは長い場合端折って 10行くらいで切れた状態で表示される、長文でもcanvas上で縦に長くならない
- テキストボックスはラインで結ぶことができ、テキストの連結、順序を表現できる
- テキストボックスおよびラインの削除は、要素をクリック＆フォーカスして右クリックでコンテキストメニュー表示、コンテキストメニュー内に『削除』があり選択されたらその要素は削除される
- ラインには終点始点があって、向かう先に対しての矢印となっている
- ライン作成時ループになるようであればエラーダイアログを出してラインは作成されない
- テキストボックスをクリックすると左ペインに markdown エディタがドロワ形式で出てきて、そこで全文閲覧＆編集ができる
- ドロワが開いている時に別ノードをクリックしたら、クリックしたノードのテキストに切り替わる(なので切り替わり時に古いノードのテキストは保存されないといけない)
- markdown エディタ内では pure text の edit mode と markdown レンダリングの preview モードがある
- テキストボックス追加ボタンで空のテキストボックスが追加される
- テキストボックスが無い背景部分をドラッグすると全体を移動できる
- ローカルファイルにデータをセーブ/ロードできる、ノードの配置なども保存される、形式は json で良い

### LLM サポート機能

- 画面下部にAIプロンプト入力ボタンがあり、プロンプトを入力するとその内容を LLM 調査して結果(返答を)新しいテキストボックスとして追加する
- LLM で生成したテキストボックスにはリンクを張らなくて良い
- テキストボックスを選択した状態でAIプロンプトを入力すると、選択テキストボックスをコンテキストとしてそのテキストに対するプロンプト指示になる
- 複数テキストボックス選択した場合全てコンテキストとして用いられる、ラインで結ばれていたときコンテキストの順番はそのノード順となる
- 背景クリックで選択状態が解除される
- LLM および画像生成のために OpenAI 互換 API を通じて利用ができる、OpenRouter や Ollama を想定
- アプリの設定として OpenAI 互換の BaseURL, APIkey, ModelName が指定できる
- テキストにはテキスト本文だけで無く、100文字程度のサマリーも情報として持っており、編集ペインには下部にそのサマリー表示とサマリー生成ボタンがある
- LLM の応答で作られたテキストボックスにはそのサマリーが自動で埋め込まれている(サマリーの生成もプロンプト実行のフローに含まれる)

## Phase2 での機能拡張

### ノード整頓ボタン

- 整頓ボタンを押すことでキャンパス上のノード位置が整理されるボタン

### 画像ボックス＆生成

- プロンプトボックスにいれたプロンプトで画像生成ができる様にする
- プロンプトボックスのモードに、Text/Image の切り替えトグルスイッチを付ける
- テキストボックスを選択した状態で Image プロンプトを入力すると、選択テキスト群をコンテキストにして、プロンプトを描画指令とした画像生成を行い画像ボックスとして表示する
- 生成した画像は設定にて指定した画像ダウンロードフォルダに保存される、デフォルト値はアプリの実行ファイルとおなじディレクトリにある "Image/"
- 選択に他の画像が含まれていたらその画像も入力コンテキストとして画像生成APIに渡す
- LLM text プロンプト時は一旦画像ボックスは無視される

### 画像生成設定

- 画像生成 API 設定は LLM 設定とは別に追加する
- 画像生成に使うプロバイダーは OpenRouter のみとする
- OpenRouter での画像生成モデル利用は以下のコール形態である

```
import requests
import json

response = requests.post(
  url="https://openrouter.ai/api/v1/chat/completions",
  headers={
    "Authorization": "Bearer <OPENROUTER_API_KEY>",
    "Content-Type": "application/json",
  },
  data=json.dumps({
    "model": "sourceful/riverflow-v2-standard-preview",
    "messages": [
        {
          "role": "user",
          "content": "Generate a beautiful sunset over mountains"
        }
      ],
    "modalities": ["image", "text"]
  })
)

result = response.json()

# The generated image will be in the assistant message
if result.get("choices"):
  message = result["choices"][0]["message"]
  if message.get("images"):
    for image in message["images"]:
      image_url = image["image_url"]["url"]  # Base64 data URL
      print(f"Generated image: {image_url[:50]}...")
```

### ファイルインポート

- エクスプローラーのドラッグアンドドロップで .txt, .md をテキストボックスに、.jpg, .png, .webp を画像ボックスとして canvas に取り込む
- テキストは内部のテキストボックスに保持
- インポート画像は、画像ダウンロードフォルダの下に Import を作成しそこにコピーして利用、デフォルト時は "Image/Import/"

## Phase3 での機能拡張

### エクスポート

- テキストボックス単位での markdown ファイルエクスポート
- 画像ボックス単位での画像ファイルエクスポート
- ノード上で右クリックのコンテキストメニューから export を選択すると OS ファイルダイアログが表示されて、保存先を指定
- 選択項目からスライド作成、Marp 形式の markdown にまとめてエクスポートする
  - ひとまずこれで実装、良いスライドを作るアルゴリズムは追々考えて更新していく


### ビジョン解析

- LLM プロンプト入力時、画像ボックスが選択に含まれていたらマルチモーダル要素としてコンテキストに含める
  - 画像を与えて解析結果を LLM の応答条件に含めることができる
- 画像プロンプト入力時、画像ボックスが選択に含まれていたらマルチモーダル要素としてコンテキストに含める
  - image2image で画像編集を行う事ができる

### コンテキストの高性能化

- ノードの上流にリンクを張られたノードがある場合はそれらを辿って一連のコンテキストとして挿入する
- リンクノードがある場合はノード1つ選択するだけで関連ノードもコンテキストに含まれる
- 上流に 2つ以上のリンクノードがある場合は一旦エラーということで、追跡はそこまでにする
  - 将来的に両方を辿って全ての上流をマージする動作にする

### その他改善

- 設定ダイアログに「キャンバス初期化」ボタンを付ける、押すとキャンバスがクリアされ初期インフォメーションノードのみの配置となる


## Phase4 での機能拡張

### 画像APIを増やす

- 現在 OpenRouter 対応のみだが他の API も対応する
- OpenAI, xAI, gemini 対応
- API key と model 以外の設定項目(Base URL)は不要になるので削除する
