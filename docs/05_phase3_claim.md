# 要求仕様書 (Phase 3)

## 1. はじめに

本ドキュメントは「fm-doc-canvas」の Phase 3 における機能拡張の要求仕様をまとめたものである。
Phase 3 では、蓄積した情報の**活用（エクスポート）**、**マルチモーダルAI能力の統合（ビジョン解析）**、および**コンテキスト処理の高度化**を実装し、ツールとしての実用性を飛躍的に高めることを目的とする。

## 2. 機能要件

### 2.1 エクスポート機能 (Export)

作成したメモや画像を外部ファイルとして取り出す機能を提供する。

*   **個別エクスポート**:
    *   ノード上のコンテキストメニュー（右クリック）に「Export」メニューを追加する。
    *   **テキストノード**: 内容を Markdown ファイル (`.md`) として保存する。
    *   **画像ノード**: 画像ファイルを元の形式（`.png`, `.jpg` 等）で保存する。
    *   操作時、OS標準のファイル保存ダイアログを表示し、ユーザーが保存先を指定できるようにする。

*   **スライド作成 (Marp Export)**:
    *   複数のノードを選択した状態、あるいは単一ノードからのコンテキストメニューで「Export as Slides (Marp)」を選択可能にする。
    *   選択されたノード（およびその繋がり）を、スライド作成ツール **Marp** 互換の Markdown 形式に変換して出力する。
    *   **変換ルール（暫定）**:
        *   各ノードをスライドの 1 ページ（区切り `---`）とする。
        *   テキストノードの内容はそのままスライド本文へ。
        *   画像ノードは画像埋め込み記法で配置。
        *   順序は選択順、または接続順（後述のコンテキストトラバーサル順）に基づく。

### 2.2 ビジョン解析とマルチモーダル入力 (Vision & Multimodal)

LLM および画像生成のコンテキストとして、テキストだけでなく「画像」を入力可能にする。

*   **LLM Text モード時の画像入力 (Vision API)**:
    *   プロンプト入力時、選択範囲に「画像ノード」が含まれている場合、その画像データを LLM への入力（Multimodal Message）に含める。
    *   ユースケース: 「この画像の UI の改善点を挙げて」「この図表からデータを読み取って要約して」といった指示が可能になる。
    *   API 仕様: OpenAI 互換の Vision API (gpt-4o, claude-3.5-sonnet 等) のメッセージ構造 (`type: "image_url"`) に対応する。

*   **Image 生成モード時の画像入力 (Image-to-Image)**:
    *   画像生成プロンプト入力時、選択範囲に「画像ノード」が含まれている場合、その画像を「参照画像（Input Image）」として生成 API に渡す。
    *   ユースケース: 画像のバリエーション生成、スタイル変換など。
    *   実装は OpenRouter 等の Image-to-Image 対応エンドポイント仕様に従う。

### 2.3 コンテキストトラバーサルの高度化 (Advanced Context)

これまでは「選択されたノードのみ」をコンテキストとしていたが、Phase 3 では「文脈の流れ」を自動で汲み取る機能を実装する。

*   **上流ノードの自動追跡**:
    *   あるノードを選択してプロンプトを実行する際、そのノードに接続されている**上流（Source側）のノード**を自動的に探索し、コンテキストに含める。
    *   これにより、ユーザーは一番下のノードを一つ選択するだけで、そこに至るまでの議論やメモの経緯を含めた指示が出せるようになる。
*   **探索の制約**:
    *   上流へのリンクを再帰的に辿る。
    *   **分岐の制限**: 上流に 2つ以上のリンク元がある（分岐合流している）場合、複雑性を避けるため、Phase 3 ではそこで探索を打ち切るか、エラーとして処理を中断する（「分岐があるためコンテキストを自動結合できません」等の警告）。
    *   将来的にマージロジックを実装するための第一歩とする。

### 2.4 その他 UX 改善

*   **キャンバス初期化**:
    *   設定モーダル内、またはメニューバーに「Clear Canvas（キャンバス初期化）」ボタンを追加する。
    *   実行時、確認ダイアログを経て、現在のキャンバス上の全てのノードとエッジを削除し、初期状態（ようこそメッセージ等のみの状態）に戻す。

## 3. UI/UX への変更点

*   **コンテキストメニュー**:
    *   ノード右クリックメニューに `Export` および `Export as Slides (Marp)` を追加。
*   **設定画面**:
    *   `Clear Canvas` ボタンの配置（Danger Zone として区別表示が望ましい）。
*   **プロンプトバー**:
    *   画像がコンテキストに含まれている場合、視覚的なインジケータ（「＋Image」アイコンやバッジ）を表示し、ユーザーに画像も送信されることを明示する。

## 4. API / データフローへの影響

*   **Vision API リクエスト**:
    *   従来の `content: string` 形式から、`content: [{type: "text", ...}, {type: "image_url", ...}]` の形式へメッセージ構築ロジックを変更する必要がある。
*   **エクスポート処理**:
    *   Frontend (React) 側でデータ整形を行い、Backend (Wails) の `SaveFileDialog` とファイル書き込み機能を利用して保存するフローとなる。