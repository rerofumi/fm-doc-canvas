# 要求仕様書 (Phase 2)

## 1. はじめに

本ドキュメントは「fm-doc-canvas」の Phase 2 における機能拡張の要求仕様をまとめたものである。
Phase 2 では、Phase 1 のテキストメモ機能に加え、**画像情報の取り扱い（表示・生成・インポート）** および **キャンバスの整頓機能** を実装する。

## 2. 機能要件

### 2.1 ノード整頓 (Auto-layout)

*   **整頓ボタン**:
    *   UI上に「整頓ボタン」を配置する。
    *   ボタン押下時に、キャンバス上の全てのノードの配置を自動的に整理・再配置する。
    *   ノード間の接続関係（ライン）を考慮し、重なりが少なく、流れが視認しやすいレイアウト（例: Dagreレイアウト等）を適用すること。

### 2.2 画像ボックス (Image Node)

*   **画像ノード表示**:
    *   テキストノードとは異なる新しいノードタイプとして「画像ノード」を追加する。
    *   キャンバス上で画像を表示できること。
*   **操作**:
    *   ドラッグによる移動、選択、削除（コンテキストメニュー）はテキストノードと同様に行えること。
    *   （推奨）リサイズハンドルを持ち、ユーザーが画像の表示サイズを変更できると望ましい。
*   **データ保持**:
    *   画像のファイルパス（ローカルパス）を保持する。

### 2.3 画像生成 (Image Generation)

*   **プロンプトモード切替**:
    *   画面下部のプロンプト入力バーに、生成モードを切り替えるトグルスイッチ（**Text / Image**）を追加する。
    *   **Textモード**: Phase 1 同様、LLMによるテキスト生成を行う。
    *   **Imageモード**: 画像生成APIを使用して画像を生成する。
*   **画像生成フロー**:
    1.  **コンテキスト収集**:
        *   選択中のテキストノードの内容をプロンプト（描画指示）として使用する。
        *   選択中に「画像ノード」が含まれる場合、その画像を「入力画像（参照画像）」としてAPIに渡す（Multimodal入力）。ただし、画像ノードをAPIに渡す部分は Phase3 での実装予定とする。
        *   選択がない場合は、プロンプト入力バーのテキストのみを使用する。
    2.  **API実行**:
        *   OpenAI互換API（**OpenRouter** 限定）を通じてリクエストを行う。
        *   モデル設定に基づき、Text-to-Image または Image-to-Image の生成を行う。
    3.  **保存と表示**:
        *   生成された画像データはローカルに保存される。
            *   保存先: 設定された「画像ダウンロードフォルダ」（デフォルト: アプリ実行ファイル同階層の `Image/`）。
        *   保存された画像を指す「画像ノード」をキャンバスに新規追加する。
*   **制約事項**:
    *   LLM Textモード実行時は、選択範囲に含まれる画像ノードは（Phase 2 時点では）無視する。

### 2.4 ファイルインポート (File Import)

*   **Drag & Drop インポート**:
    *   OSのエクスプローラー等からキャンバスへのファイルドロップを受け付ける。
*   **テキストファイル (.txt, .md)**:
    *   内容を読み込み、新しい「テキストノード」として追加する。
*   **画像ファイル (.jpg, .png, .webp)**:
    *   ファイルを「インポート用フォルダ」にコピーする。
        *   保存先: 画像ダウンロードフォルダ配下の `Import/` ディレクトリ（例: `Image/Import/`）。
    *   コピーされたファイルを参照する「画像ノード」を追加する。

### 2.5 アプリ設定 (Settings) の拡張

*   **画像生成設定**:
    *   LLM設定とは独立した設定項目を追加する。
    *   **Provider**: OpenRouter（固定）。
    *   **Base URL**: OpenRouter用のエンドポイント（`https://openrouter.ai/api/v1` 等）。
    *   **API Key**: 画像生成用のAPIキー（LLM用と共有可だが、設定項目としては分けるか、明示的に共有設定とする）。
    *   **Model Name**: 使用する画像生成モデル（例: `sourceful/riverflow-v2-standard-preview`）。
    *   **Download Path**: 生成画像の保存先フォルダ（デフォルト: `./Image/`）。

## 3. データモデルへの影響

### 3.1 ノードデータの拡張 (JSON Schema)

Phase 1 の `nodes` 配列に対し、新しい `type` を許容する必要がある。

*   **Existing**: `type: "customNode"` (Text Node)
*   **New**: `type: "imageNode"` (Image Node)

**Image Node Data Structure (例)**:
```json
{
  "id": "uuid-image-1",
  "type": "imageNode",
  "position": { "x": 200, "y": 200 },
  "data": {
    "src": "Image/generated_001.png", // 実行ファイルまたは設定ルートからの相対パス
    "alt": "Generated sunset image"    // 生成時のプロンプトやファイル名を保持
  }
}
```

### 3.2 既存機能との互換性
*   Phase 1 で作成されたキャンバスデータ（JSON）を読み込んだ際、Phase 2 アプリでも問題なく動作すること。
*   Phase 2 で保存した（画像を含む）データを Phase 1 アプリ（旧版）で開いた場合、画像ノードは表示されないか、または「Unknown Node」としてクラッシュせずに無視されるような堅牢性が望ましい（必須ではないが推奨）。

## 4. API連携詳細 (OpenRouter Image Gen)

OpenRouter における画像生成は `chat/completions` エンドポイントを使用し、通常のテキストチャットとは異なるペイロード構造を持つ場合があるため注意が必要。
要求仕様書（00_claim.md）に記載されたサンプルコードの実装に従う。

```json
// Request Payload Example
{
  "model": "sourceful/riverflow-v2-standard-preview",
  "messages": [
    {
      "role": "user",
      "content": "Generate a beautiful sunset..."
    }
  ],
  "modalities": ["image", "text"] // 重要
}
```
